#! /bin/bash

# Debian (post-)install scripts
# Copyright (C) 2020
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

DIR="$(dirname "$0")"

export MIDBRANCH="\0342\0224\0234\0342\0224\0200\0342\0224\0200"
export ENDBRANCH="\0342\0224\0224\0342\0224\0200\0342\0224\0200"

# # Tricks vim-autointent into thinking the default indent is 1 space.
# export heirarchy="Main
#  ${midbranch} Base
#  ${midbranch} Miscellaneous
#  ${midbranch} Desktop environment
#  ${midbranch} Network tools
#  ${midbranch} Applications
#  ${midbranch} Themes
#  ${ENDBRANCH} Personalization"

#
# Fancy color output
#

ask_question() {
  local var
  read -r -p $'\033[1;34m'"$* "$'\033[0m' var
  echo "${var}"
}
export -f ask_question

ask_secret() {
  local var
  stty -echo echonl
  read -r -p $'\033[1;34m'"$* "$'\033[0m' var
  stty echo -echonl
  echo "${var}"
}
export -f ask_secret

show_error() {
  echo -e $'\033[1;31m'"$*"$'\033[0m' 1>&2
}
export -f show_error

show_header() {
  echo -e $'\033[1;36m'"$*"$'\033[0m'
}
export -f show_header

show_info() {
  echo -e $'\033[1;32m'"$*"$'\033[0m'
}
export -f show_info

show_question() {
  echo -e $'\033[1;34m'"$*"$'\033[0m'
}
export -f show_question

show_success() {
  echo -e $'\033[1;35m'"$*"$'\033[0m'
}
export -f show_success

show_warning() {
  echo -e $'\033[1;33m'"$*"$'\033[0m'
}
export -f show_warning

show_listitem() {
  echo -e $'\033[1;37m'"$*"$'\033[0m'
}
export -f show_listitem

#
# Utility functions
#

function check_user {
  if [ ${EUID} -eq 0 ]; then
    show_error "Don't run this script as root. Exiting."
    exit 1
  fi
}

function check_root {
  if [ ${EUID} -eq 0 ]; then
    show_info "I am root."
  else
    show_error "I need to be root."
    exit 1
  fi
}

function check_fail {
  local exitstatus=${1:-}
  if [[ ${exitstatus} -gt 0 ]]; then
    show_error "Error code received. Returning to main."
    sleep 3s && main
  fi
}

function check_debian_release {
  show_header "Checking current Debian release."
  local release
  release=$(lsb_release -sc)
  if ! [[ "${release}" == "bookworm" ]] &&
     ! [[ "${release}" == "bullseye" ]] &&
     ! [[ "${release}" == "trixie" ]] &&
     ! [[ "${release}" == "sid" ]]; then
    show_warning "This script is not intended for Debian ${release@Q}."
    exit 1
  else
    show_success "Now running ${release@Q}."
  fi
}

function check_installed {
  local package
  local to_install=()
  while read -r package; do
    [ -z "${package}" ] && continue

    # Check if package is installed already before installing.
    if dpkg -s "${package}" > /dev/null 2>&1; then
      show_listitem "${package@Q} already installed. Skipping."
    else
      # First check if the package exists in the repos.
      if ! (apt-cache showsrc "${package}" 2>&1 | grep -q "W: "); then
        to_install+=("${package}")
      else
        show_warning "${package@Q} does not exist in the repos. Skipping."
      fi
    fi
  done < "${1}"
  if [[ -v to_install ]]; then
    sudo apt-get -y install "${to_install[@]}"
  fi
}

function check_uninstalled {
  local package
  while read -r package; do
    [ -z "${package}" ] && continue

    if dpkg -s "${package}" > /dev/null 2>&1; then
      show_listitem "Purging ${package@Q}."
      sudo apt-get -y purge "${package}"
      sudo apt-get -y autoremove
    else
      show_warning "${package@Q} is not installed. Skipping."
    fi
  done < "${1}"
}

function sync_repos {
  show_header "Synchronizing repos."
  if [ ${EUID} -eq 0 ]; then
    apt update
  else
    sudo apt update
  fi
}

function install_post_dependencies {
  local deps="${DIR}/packages/deps.list"
  show_header "Checking post-installation dependencies."
  local package
  while read -r package; do
    if ! dpkg -s "${package}" > /dev/null 2>&1; then
      show_info "${package@Q} is needed for this script."
      sudo apt-get -y install "${package}"
      check_fail $?
      show_success "${package@Q} now installed."
    else
      show_success "${package@Q} is already installed."
    fi
  done < "${deps}"
}

function install_dependencies {
  local install="${DIR}/packages/install.list"
  show_header "Checking installation dependencies."

  local state=true
  local exe
  while read -r exe; do
    if ! command -v "${exe}" > /dev/null; then
      state=false
    fi
  done < "${install}"
  if "${state}"; then return; fi

  local package
  while read -r package; do
    if ! dpkg -s "${package}" > /dev/null 2>&1; then
      show_info "${package@Q} is needed for this script."
      apt-get -y install "${package}"
      check_fail $?
      show_success "${package@Q} now installed."
    else
      show_success "${package@Q} is already installed."
    fi
  done < "${install}"
}

function install_sudo {
  if ! command -v dpkg > /dev/null; then
    show_error "dpkg not installed. Exiting."
    exit
  fi
  if ! dpkg -s sudo > /dev/null 2>&1; then
    show_header "sudo is needed for this script."
    show_info "Installing sudo via root (enter root password):"
    if [ ${EUID} -eq 0 ]; then
      apt-get -y install sudo
      show_success "sudo installed." # will exit after check_user()
    else
      su root - sh -c "apt-get -y install sudo && /sbin/adduser $(whoami) sudo"
      show_success "sudo installed and $(whoami) added to group sudo."
      show_info "Log out and log back in again."
      exit
    fi
  elif ! [[ $(groups) =~ \ *sudo\ * ]]; then
    show_error "User $(whoami) not in sudoer group."
    show_info "If the root user is enabled, run:"
    show_listitem "su root - sh -c \"/sbin/adduser $(whoami) sudo\""
    show_info "Then, log out and log back in again."
    exit
  fi
}

function check_network {
  show_header "Checking network connection."

  if ! command -v curl > /dev/null 2>&1; then
    show_error "curl not installed. Exiting."
    exit 1
  fi

  if curl --retry 5 --retry-connrefused -Is https://debian.org > /dev/null; then
    show_success "Network is working."
  else
    show_error "Cannot start network connection."
    exit 1
  fi
}

function set_config_key_value {
  local file="${1}"
  local key="${2}"
  local value="${3}"

  if [ -f "${file}" ]; then
    if grep -q "^${key}" "${file}"; then
      sed -i "s,^${key}=.*,${key}=${value},g" "${file}"
    else
      echo "${key}=${value}" >> "${file}"
    fi
  else
    show_warning "${file@Q} does not exist. Creating new."
    mkdir -p "$(dirname "${file}")"
    echo "${key}=${value}" > "${file}"
  fi
}

function copy_config_file {
  local source="${1}"
  local dest="${2}"

  if ! [ -f "${source}" ]; then
    show_error "${source@Q} not found. Exiting."
    exit 1
  fi

  show_info "Copying ${source@Q} to ${dest@Q}."
  if [ -f "${dest}" ]; then
    if ! cmp -s "${source}" "${dest}"; then
      show_info "Backing up existing ${dest@Q}."
      mv -v "${dest}" "${dest}_$(date +%Y%m%d-%k%M%S).bak"
      cp -v "${source}" "${dest}"
    else
      show_info "${dest} already set."
    fi
  else
    cp -v "${source}" "${dest}"
  fi
}
